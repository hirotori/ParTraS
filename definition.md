# Lagrangean ç²’å­è¿½è·¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®é–‹ç™º

åå‰ã¯ã¾ã ãªã„. ä»®ã§"PARTRAS" (Particle TRAcking Simulator)ã¨åä»˜ã‘ã¦ã„ã‚‹. 

å€™è£œ:
- DROPS (DROplet Particle Simulator)
- LAPTRAN (Lagrangean Approach for Particle Tracking in FortRAN)
- FoPAS (Fortran-based Particle Advection SImulator)


## ã‚„ã‚ŠãŸã„ã“ã¨
- æµã‚Œå ´ã‚’æµ®éŠã™ã‚‹ç²’å­ã®é‹å‹•ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã‚’æä¾›ã™ã‚‹.
- æ‹¡å¼µæ€§ã‚’è€ƒæ…®ã—ã¦, ã‚¯ãƒ©ã‚¹ã‚’ç”¨ã„ãŸè¨­è¨ˆã‚’è¡Œã†.
- ä»–ã®è¨€èªã«å¯¾ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹. 

## fortran coding rule
- ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ UpperCamelCase ã§å‘½åã™ã‚‹
- fortranã®å¤‰æ•°ã‚„é–¢æ•°, ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã©ã¯åŸå‰‡ snake_case ã¨ã™ã‚‹.
- å¤‰æ•°åã«ã¤ã„ã¦ã¯åŸå‰‡çœç•¥å½¢ã‚’ç”¨ã„ãªã„ 
  - æ…£ä¾‹çš„ãªèªå¥ã¯çœç•¥å½¢ã‚’ç”¨ã„ã¦ã‚‚è‰¯ã„ãŒ, ã‚³ãƒ¡ãƒ³ãƒˆã§ä½•ã®æ„å‘³ã‹ã‚’æ˜è¨˜ã™ã‚‹.
- ã‚³ãƒ¡ãƒ³ãƒˆã¯ FORD ã‚¹ã‚¿ã‚¤ãƒ«ã«å¾“ã†.
- æ´¾ç”Ÿå‹ã®åå‰ã¯`_t`ã‚’æœ«å°¾ã«ã¤ã‘ã‚‹
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åå‰ã¯`_m`ã‚’æœ«å°¾ã«ã¤ã‘ã‚‹
- privateå¤‰æ•°ã¯`_`ã‚’æœ«å°¾ã«ã¤ã‘ã‚‹
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ•°ã¯`mv_`ã‚’å…ˆé ­ã«ã¤ã‘ã‚‹. 
- å¾Œå§‹æœ«ã¯ `delete_`ã‚’å…ˆé ­ã«ã¤ã‘ã‚‹. 
- ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯é–¢æ•°ã§ã¯ãªãã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ã¨ã™ã‚‹. 
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ `construct_`ã‚’å…ˆé ­ã«ã¤ã‘ã‚‹. 
 
### do OOP or not ?
OOPã«ã™ã‚‹ã¨, 
- ğŸ˜„ ç¶™æ‰¿ãŒä½¿ãˆã‚‹ã®ã§å†åˆ©ç”¨ãŒæ¥½. 
- ğŸ˜„ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãƒ¼ã§ãƒ¡ãƒ³ãƒã®å€™è£œãŒå‡ºã¦ãã‚‹ã®ã§æ¥½.
- ğŸ˜¢ ãƒ¡ãƒ³ãƒã®éš è”½ãŒã‚ã‚“ã©ãã•ã„. ã„ã¡ã„ã¡ã‚²ãƒƒã‚¿ãŒã„ã‚‹. 
  - éš è”½ã—ãªãã¦ã‚‚å¯èƒ½. Pythonã®æ€æƒ³ã«è¿‘ã„.
  - Fortranã®å ´åˆsubroutineã®intentå±æ€§ã§ã‚ã‚‹ç¨‹åº¦åˆ¶é™ã§ãã‚‹. å†—é•·ã«ãªã‚ŠãŒã¡. 
- ğŸ˜¢ ãã‚‚ãã‚‚, ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®å ´åˆ, OOPã®æ©æµãŒå°‘ãªã, è‡ªå·±æº€è¶³ã«ãªã‚ŠãŒã¡.
  - ç¶™æ‰¿ã¨ã‹ã‚ã¾ã‚Šä½¿ã‚ãªã„ã“ã¨ãŒå¤šã„. MDã¿ãŸã„ã«è¤‡æ•°ã®ç©åˆ†æ³•ã‚„æ§˜ã€…ãªçµ±è¨ˆå‡¦ç†ãŒé–¢ã‚ã£ã¦å¤§è¦æ¨¡ã‹ã¤è¤‡é›‘åŒ–ã™ã‚‹ãªã‚‰æ©æµã¯ã‚ã‚‹ãŒ, 
    é£›æ²«è¨ˆç®—ã®å ´åˆã¯ã‚„ã‚‹ã¹ãå‡¦ç†ãŒã»ã¼æ±ºã¾ã£ã¦ã„ã‚‹ã®ã§, ã‚€ã—ã‚ç„¡é§„ã«è¤‡é›‘åŒ–ã™ã‚‹æã‚ŒãŒã‚ã‚‹. 

ãã“ã§...

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§é‡è¦ãª2ã¤ã®ãƒ‡ãƒ¼ã‚¿: ç²’å­æƒ…å ±ã¨æµã‚Œå ´æƒ…å ± `particle_data`, `flow_field`ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ•°ã¨ã™ã‚‹. 
* ã¨ãã« `flow_field`ã¯protectedå±æ€§ã‚’ã¤ã‘, ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤–ã‹ã‚‰ã¯ãƒ¡ãƒ³ãƒå¤‰æ•°ã¯å‚ç…§onlyã¨ã™ã‚‹. ãƒ¡ãƒ³ãƒã®å¤‰æ›´ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å®šç¾©ã—ãŸé–¢æ•°ã®ã¿è¨±å¯. 
  ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¿ãŸã„ãªã‚‚ã®ã ãŒ, protectedå±æ€§ã§å¤–éƒ¨ã‹ã‚‰ã¯å‚ç…§ã—ã‹ã§ããªã„æ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„. 
* `particle_data`ã¯æ›¸ãè¾¼ã¿, å‚ç…§ãŒè‡ªç”±. **ç´³å£«å”å®š**ã¨ã—ã¦, `particle_data`ã®åˆæœŸåŒ–, ç ´æ£„, ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾©ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ã‹ã‚‰è¡Œã†. 
  * ã‚¯ãƒ©ã‚¹ã«ã™ã‚Œã°ãˆãˆã‚„ã‚“ã¨æ€ã†ã‹ã‚‚ã—ã‚Œãªã„ãŒ, æ§‹é€ ä½“ã«ã™ã‚‹ã“ã¨ã§Pythonã¨ã®ã‚„ã‚Šå–ã‚ŠãŒç°¡å˜ã«ãªã‚‹åˆ©ç‚¹ãŒã‚ã‚‹. 
* ã„ã‚ã°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãã®ã‚‚ã®ãŒä¸€ã¤ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸. 

ãã®ä»–
* å‹•çš„ãƒªã‚¹ãƒˆ`Idlist`, æ ¼å­èª­ã¿è¾¼ã¿å‡¦ç†`ugrid_importer_t`ãªã©, ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ã®é«˜ã„ã‚‚ã®, åˆ¥ã®æ–¹æ³•ã‚’è©¦ã—ãŸã„å¯èƒ½æ€§ã®ã‚ã‚‹å‡¦ç†ã¯ã‚¯ãƒ©ã‚¹ã«ã™ã‚‹. ã»ã‹ã« updater, dump_writerãªã©. 

## ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®ä¸­èº«
**ä¸»ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
- `ugrid_importer_t`
  - ä½•ã‚‰ã‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§`ugrid_struct_t`ã‚’æ§‹ç¯‰ã™ã‚‹. 
  - read_file: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€. `ugrid_struct_t`ã‚’è¿”ã™ (subroutine)
  - delete: ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™. 
- `ugrid_struct_t`
  - å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿å–ã£ãŸæ ¼å­ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒã™ã‚‹ãŸã‚ã®æ§‹é€ ä½“. 
  - `flow_field_t`ã®æ§‹ç¯‰ã¯ã“ã®æ§‹é€ ä½“ã‚’å¼•æ•°ã«æ¸¡ã—ã¦è¡Œã†. ã“ã†ã™ã‚‹ã“ã¨ã§, ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä¸€ã¤ã«çµ±ä¸€ã§ãã‚‹. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾å­˜æ€§ã‚’æ¶ˆã™ãŸã‚ã®å‡¦ç½®. 
- `particle_data_t`
  - ç²’å­ã®ä½ç½®, é€Ÿåº¦
  - ç”Ÿæ­»çŠ¶æ…‹
  - æ›¸ãå‡ºã—ã¨èª­ã¿å–ã‚Šã®å®šç¾©
  - ç²’å­ã®è¿½åŠ 
- `flow_field_t`
  - ç¯€ç‚¹åº§æ¨™, ã‚»ãƒ«ä¸­å¿ƒ, é¢ä¸­å¿ƒ, å¢ƒç•Œé¢, éš£æ¥é–¢ä¿‚
  - æµä½“ã®é€Ÿåº¦å ´
  - ã‚»ãƒ«é€Ÿåº¦ --> ç¯€ç‚¹é€Ÿåº¦ã¸ã®å¤‰æ› (å¿…è¦?)
- `motion_t`
  - ç²’å­ã®é‹å‹•ã®å®šç¾©
- `simulator_t`
  - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“. 
    - `particle_data_t`ã¨`flow_field_t`ã¯ã™ã§ã«æ§‹ç¯‰æ¸ˆã¿ã¨ã™ã‚‹.
  - ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—:
    - æµã‚Œå ´ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° 
    - ç²’å­ã®é‹å‹•
    - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    - ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—
  - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ç™»éŒ², å‘¼ã³å‡ºã—
- `field_updater_t`
  - æµã‚Œå ´ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼.
  - æŒ‡å®šã—ãŸ`importer_t`ã§æ›´æ–°ã™ã‚‹. 
  - ç²’å­é‹å‹•ã®æ™‚é–“åˆ»ã¿å¹…ã¨æµã‚Œå ´ã®æ™‚é–“åˆ»ã¿å¹…ã‹ã‚‰, ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨ˆç®—ã™ã‚‹  
- `callback_t`
  - `simulator_t`ã§å‘¼ã³å‡ºã™ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†. 

**ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—**
- `flow_field_t`, `particle_data_t`ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹. 
- ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã™ã‚‹ã‹, HDF5ã¿ãŸã„ãªåœ§ç¸®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§, ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦
  ã²ã¨ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ã‹ (HOOMDã§ã„ã†`.gsd`ã¿ãŸã„ãªã‚„ã¤.)

å¯è¦–åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Legacy VTKã¨ã™ã‚‹. å½“åˆ†å›°ã‚‹ã“ã¨ã¯ãªã„ã®ã§ã“ã‚Œã§. ãŸã ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ã§ååˆ†. 

**ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
è¨ˆç®—çµæœã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ. æ‹¡å¼µå­ã¯`.pdata`ã¨ã™ã‚‹. 
- ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹. ãƒ•ã‚¡ã‚¤ãƒ«åã¯`tag_#####.pdata`ã¨ã™ã‚‹. 
- `tag`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã™ã‚‹. æ•°å­—`#####`ã¯æ•´æ•°ã§, ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ—ã¨ã™ã‚‹. 

```markdown
# number of particle
(number of particle)
# particle attributes (pos, vel, f, ...)
(data for 1st particle)
(data for 2nd particle)
(...)
```

- ãƒã‚¤ãƒŠãƒªå½¢å¼ã®å ´åˆ, æ–‡å­—åˆ—ã¯æ›¸ãè¾¼ã¾ãªã„. 
  - number of particle $N_{p}$ (4byte)
  - particles (56byte*$N_p$) â€»ç¾åœ¨ã®å®šç¾©

- æ›¸ãè¾¼ã¿å½¢å¼ã¯`stream`ã§.
- å¯è¦–åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¯åˆ¥ã«ã™ã‚‹. 

**ãƒªã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†**
- `particle_data_t`: ãƒ•ã‚¡ã‚¤ãƒ«`.pdata`ã‹ã‚‰å–å¾—.


èª°ãŒã‚„ã‚‹? --> DumpReader?
- DumpReaderã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã§ãã‚‹ç‰¹åˆ¥ãªå­˜åœ¨ã«ãªã£ã¡ã‚ƒã†.
- å¾Œå‡¦ç†ã§ä½¿ã†ã“ã¨è€ƒãˆã‚‹ã¨åˆ¥ã«å•é¡Œãªã„ã‹.

å‡¦ç†ã®æµã‚Œ: 
1. `backup.pdata`ã‚’èª­ã¿è¾¼ã‚€. 
2. `backup.pdata`ã®ç²’å­æƒ…å ±ã‹ã‚‰`pdata`ã‚’åˆæœŸåŒ–ã™ã‚‹
3. `backup.pdata`ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æµã‚Œå ´ã‚’æ§‹ç¯‰ã™ã‚‹
4. æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ—`ncyc`ã¯èª°ãŒæŒã¤?
updater, writerãªã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãŒé€ä¸€ç”¨æ„ã™ã‚‹. 

**CFDãƒ¡ãƒƒã‚·ãƒ¥ã‚µãƒãƒ¼ãƒˆ**
- `ugrid_importer_t`ã‚’ç¶™æ‰¿ã—ã¦ä½œæˆã™ã‚‹. 
- `read_file`ã‚’å„è‡ªå®Ÿè£…ã™ã‚‹. 
  - `.pre`, `.fld`, `.fph`, CUBEé–¢é€£ã®ã‚„ã¤
- ãƒ†ã‚¹ãƒˆç”¨ã«Legacy VTKã®ã‚¤ãƒ³ãƒãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¦ã„ã‚‹. 

**å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ä¾å­˜**
- stdlib: ãƒ­ã‚¬ãƒ¼ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ«, ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã¯ä½¿ãˆã‚‹ã‹ã‚‚. 
- VTKFortran: ä¸è¦. 
- HDF5: æœ‰åŠ›å€™è£œ

*å»ƒæ­¢äºˆå®š*
- `struct_array3_t` (deprecated)
  - ãƒ™ã‚¯ãƒˆãƒ«x,y,zæˆåˆ†ã‚’ãƒ¡ãƒ³ãƒã«æŒã¤æ§‹é€ ä½“
  - åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã¯æ§‹é€ ä½“ã®é…åˆ—ã§å®Ÿè£…ã™ã‚‹.
  - ï¼”ã¤ç›®ã®æˆåˆ†ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åŠ ãˆã‚‹ãªã©ã—ã¦ã‚‚è‰¯ã„. 
  - ä½œã£ã¦ã¯è¦‹ãŸãŒ, ã‚„ã£ã±ã‚Šä½¿ã‚ãªã„. ä½¿ã„ã«ãã„ã®ã§.

## motion
`particle_data_t`ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã›ãš, ã“ã¡ã‚‰ã§ä¾‹ãˆã°ç²’å­ã®åŠå¾„ã‚„ç²’å­ã«åƒãåŠ›ã‚’è¨­å®šã™ã‚‹. 
```Fortran

type motion_base_t
  
  contains
  procedure integrate_a_step
  procedure update_status

end type

```

`integrate_a_step`ã§ã€€ç²’å­ã®ä½ç½®ã¨é€Ÿåº¦ã‚’æ›´æ–°ã™ã‚‹. ç‹¬è‡ªã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã“ã‚Œã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹. 

```Fortran
pure subroutine integrate_a_step(this, r, v, u, dt)
  class(motion_base_t),intent(in) :: this
  type(scalar4_t),intent(inout) :: r
  type(scalar4_t),intent(inout) :: v
  type(scalar4_t),intent(in   ) :: u
  real(dp),intent(in) :: dt

end subroutine

```

`update_status`ã¯ã‹ãªã‚Šè‡ªç”±ã«ç²’å­ã®çŠ¶æ…‹ã‚’ç·¨é›†ã§ãã‚‹. å¼·åˆ¶çš„ã«ç²’å­ã‚’æ­¢ã‚ã‚‹ã“ã¨ã‚‚ã§ãã‚‹. ç²’å­åŠå¾„ã®å¤‰åŒ–ã‚‚ã“ã“ã§ã‚„ã‚‹. 
ã“ã®å‡¦ç†ã®å¦¥å½“æ€§ã®ä¿è¨¼ã¯, ã“ã®ã‚¯ãƒ©ã‚¹ã‚’æ‹¡å¼µã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è²¬ä»»ãŒã‚ã‚‹. 

## è¿½åŠ ã®å‡¦ç†
ä¾‹ãˆã°, ç²’å­é–“ã®åˆä½“å‡¦ç†, ç²’å­ã®è¿½åŠ å‡¦ç†. 
ã“ã‚Œã¯ `simulator_t` ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‡¦ç†ã™ã‚‹. 

## src/
ã‚¦ã‚¤ãƒ«ã‚¹é£›æ²«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿. å‡¦ç†ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã”ã¨ã«ã‚ã‘ã¦æ›¸ã„ã¦ãŠã. ãƒ¡ã‚¤ãƒ³é–¢æ•°ã§å‘¼ã³å‡ºã™

- system.f90: ã‚¦ã‚¤ãƒ«ã‚¹é£›æ²«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æœ¬ä½“. mainé–¢æ•°. 
  - mv_field_updaterã®å‘¼ã³å‡ºã—
  - mv_dump_writerã®å‘¼ã³å‡ºã—
- init.f90: æµã‚Œå ´(mv_flow_field)ã®åˆæœŸåŒ–, ç²’å­ãƒ‡ãƒ¼ã‚¿(mv_pdata)ã®ç”Ÿæˆ
  - ç²’å­ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ: ä¸ãˆãŸä¸­å¿ƒç‚¹å‘¨ã‚Šã«ãƒ©ãƒ³ãƒ€ãƒ ã§ç‚¹ã‚’æ‰“ã¤. é€Ÿåº¦ã¯ã‚¼ãƒ­. åŠå¾„ã¯å…±é€š. 
- update.f90: æµã‚Œå ´ã®æ›´æ–°
- config.f90: ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨è‡ªå‹•ç”Ÿæˆ
- dump.f90: ãƒ€ãƒ³ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã®åˆæœŸåŒ–

## Pythonã¨ã®é€£æº
pythonã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹. 
- pythonå´ã§ã¯ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã¶
- ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹å†…éƒ¨ã§ã¯fortranã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é–¢æ•°ã‚’å‘¼ã³å‡ºã™. 
- fortranã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é–¢æ•°å†…éƒ¨ã§ã¯ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºä¿ã™ã‚‹.
- particle_dataã®ä¸­èº«ã¯ã™ã¹ã¦fortranå´ã§ç¢ºä¿ã™ã‚‹. 

ãƒ¦ãƒ¼ã‚¶å®šç¾©ã®computeã‚¯ãƒ©ã‚¹ãªã©ã¯ã©ã†ã‚„ã£ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹?
è€ƒãˆã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹. `system`ã‚¯ãƒ©ã‚¹ã«`add_compute`ã‚’ç”¨æ„ã—, `compute`ã‚¯ãƒ©ã‚¹ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä¿æŒã•ã›ã‚‹.
ã²ã‚‡ã£ã¨ã—ãŸã‚‰, ã“ã®ãƒ«ãƒ¼ãƒãƒ³ã¯ã„ã‚‰ãªã„ã‹ã‚‚. Pythonã«å…¬é–‹ã™ã‚‹ç”¨ã®ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³å†…ã§`add_compute`ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã™ã‚Œã°æ¸ˆã‚€. 

ãªãŠ, `add_compute`ã§ã¯, `compute`ã‚¯ãƒ©ã‚¹ã¨ãã®ç¶™æ‰¿ã‚¯ãƒ©ã‚¹ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä¿æŒã™ã‚‹. ãƒã‚¤ãƒ³ã‚¿ã®é…åˆ—ã¯Fortranã®è¦æ ¼ã§ã¯é…åˆ—ã«å¯¾ã™ã‚‹ãƒã‚¤ãƒ³ã‚¿ã¨ãªã£ã¦ã—ã¾ã†ã®ã§, æ§‹é€ ä½“ã§ä»£ç”¨ã™ã‚‹. 

```Fortran
type compute_holder
    class(compute),pointer :: ptr_ => null()
end type
```
ã“ã‚Œã‚’ãƒ¡ãƒ³ãƒã¨ã—ã¦ä¿æŒã™ã‚‹

```Fortran
type system
    type(compute_holder),allocatable :: computes(:)
    !...
end type

```

Pythonã§ã¯

```Python
class compute:
  def __init__(self, args*):
    # ...
    # ctypeslibã‹ä½•ã‹ã§fortranå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã³å‡ºã™
    fort_lib.init_compute(...)
    pass

  def hoge(self, xx):
    # å¿…è¦ã§ã‚ã‚Œã°ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰
    fort_lib.set_params(...)
    pass
  
```

Fortranã§ã¯Pythonå´ã§ä½œã£ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¯¾å¿œã™ã‚‹ãƒŸãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã‚‹

```Fortran
module compute_something_m
use system, only : global_system !systemã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

!computeã‚¯ãƒ©ã‚¹ã®å®šç¾©
type,extends(compute) :: compute_something
! è«¸ã€…ã®å®šç¾©

end type

type(compute_something) compute_somthing_mv

contains
subroutine init_compute(...) bind("C", name="init_compute")
  ! å¿…è¦ãªå¼•æ•°ã‚’ç¾…åˆ—

  ! è«¸ã€…ã®å‡¦ç†
  call compute_somthing_mv%init(...)

  ! systemã«ã“ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿½åŠ 
  call global_system%add_compute(compute_something_mv)
end subroutine

! ...
end module

```

é¢å€’ãªã®ã¯, `compute`ã®æ´¾ç”Ÿã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ãŸã³ã«ã“ã‚Œã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨.
ã‚ã¨, `allocatable`å±æ€§ãŒå«ã¾ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã¯, ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã®å ´æ‰€ã«æ³¨æ„. 
ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³å†…éƒ¨ã§ä½œã£ãŸã‚¯ãƒ©ã‚¹ã¯`allocatable`å±æ€§ã®å¤‰æ•°ã¯è‡ªå‹•çš„ã«è§£æ”¾ã•ã‚Œã‚‹ãŸã‚.
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ•°ã«ã—ãªã„ã¨ã„ã‘ãªã„.

motionã‚‚åŒæ§˜ã«ã‚„ã‚Œã°ã„ã„ï¼